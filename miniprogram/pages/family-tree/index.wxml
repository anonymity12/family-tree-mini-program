<view class="container">
  <!-- 顶部搜索栏 -->
  <view class="search-bar">
    <input type="text" placeholder="搜索家庭成员" bindinput="onSearch" class="search-input" />
  </view>

  <!-- 工具栏 -->
  <view class="toolbar">
    <button class="tool-btn" bindtap="addMember">添加成员</button>
    <button class="tool-btn" bindtap="editMode">编辑模式</button>
  </view>

  <!-- 家谱树展示区域 -->
  <scroll-view class="family-tree-container" scroll-x="true" scroll-y="true" enhanced="true" show-scrollbar="true">
    <view class="family-tree">
      <block wx:for="{{treeNodes}}" wx:key="_id">
        <view class="tree-node" style="left: {{item.x}}px; top: {{item.y}}px">
          <view class="node-content" bindtap="onNodeTap" data-_id="{{item._id}}" data-member="{{item.member}}">
            <image class="avatar" src="{{item.member.avatar || '/images/default-avatar.png'}}" mode="aspectFill"></image>
            <text class="name">{{item.member.name}}</text>
            <view wx:if="{{item.hasChildren}}" 
                  class="toggle-btn {{item.collapsed ? 'collapsed' : 'expanded'}}" 
                  catchtap="onNodeTap" 
                  data-_id="{{item._id}}" 
                  data-action="toggle">
              {{item.collapsed ? '+' : '-'}}
            </view>
          </view>
          <view class="node-connection" wx:if="{{item.hasChildren && !item.collapsed}}"></view>
        </view>
      </block>
    </view>
  </scroll-view>

  <!-- 成员详情弹窗 -->
  <view class="member-detail-modal" wx:if="{{showMemberDetail}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">成员详情</text>
        <text class="close-btn" bindtap="closeMemberDetail">×</text>
      </view>
      <view class="member-info">
        <view class="info-item">
          <text class="label">姓名：</text>
          <text>{{currentMember.name}}</text>
        </view>
        <view class="info-item">
          <text class="label">出生日期：</text>
          <text>{{currentMember.birthDate}}</text>
        </view>
        <view class="info-item">
          <text class="label">关系：</text>
          <text>{{currentMember.relation}}</text>
        </view>
        <view class="info-item">
          <text class="label">简介：</text>
          <text>{{currentMember.description}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 添加成员弹窗 -->
  <view class="member-modal" wx:if="{{showAddModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">添加家庭成员</text>
        <text class="close-btn" bindtap="cancelAdd">×</text>
      </view>
      <form bindsubmit="submitNewMember">
        <view class="form-group">
          <text class="label">姓名</text>
          <input name="name" class="input" placeholder="请输入姓名" value="{{newMember.name}}" />
        </view>
        <view class="form-group">
          <text class="label">出生日期</text>
          <picker name="birthDate" mode="date" value="{{newMember.birthDate}}" start="1900-01-01" end="2100-12-31" bindchange="onBirthDateChange">
            <view class="picker-view">{{newMember.birthDate || '请选择出生日期'}}</view>
          </picker>
        </view>
        <view class="form-group">
          <text class="label">关系</text>
          <input name="relation" class="input" placeholder="例如：父亲、母亲、儿子等" value="{{newMember.relation}}" />
        </view>
        <view class="form-group">
          <text class="label">简介</text>
          <textarea name="description" class="textarea" placeholder="请输入简介" value="{{newMember.description}}"></textarea>
        </view>
        <view class="form-group">
          <text class="label">选择父节点</text>
          <view class="parent-selector" bindtap="selectParent">
            <text>{{selectedParentName ? selectedParentName + ' (点击更改)' : '点击选择父节点'}}</text>
          </view>
        </view>
        <view class="form-actions">
          <button class="btn cancel" bindtap="cancelAdd">取消</button>
          <button class="btn submit" form-type="submit">确定</button>
        </view>
      </form>
    </view>
  </view>
</view>